{% extends 'base.html' %}

{% block content %}
  <h1>Dashboard</h1>
  <div id="stats">
    <div class="raw" id="raw-area" {% if config.display=='raw' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
      <h2>Raw Stats</h2>
      <div class="raw-section" id="raw-cpu">
        <h3>CPU</h3>
        <div class="raw-row">Overall: <span id="cpu-raw">-</span>%</div>
        <div class="raw-row">Per-core: <span id="cpu-percore">-</span></div>
        <div class="raw-row">Cores (logical): <span id="cpu-cores">-</span></div>
        <div class="raw-row">Frequency: <span id="cpu-freq">-</span> GHz</div>
      </div>
      <div class="raw-section" id="raw-ram">
        <h3>RAM</h3>
        <div class="raw-row">Used: <span id="ram-used">-</span></div>
        <div class="raw-row">Available: <span id="ram-available">-</span></div>
        <div class="raw-row">Total: <span id="ram-total">-</span></div>
        <div class="raw-row">Percent: <span id="ram-raw">-</span>%</div>
      </div>
      <div class="raw-section" id="raw-net">
        <h3>Network</h3>
        <div class="raw-row">Sent: <span id="net-raw-sent">-</span></div>
        <div class="raw-row">Received: <span id="net-raw-recv">-</span></div>
        <div class="raw-row">Send rate: <span id="net-raw-sent-rate">-</span></div>
        <div class="raw-row">Recv rate: <span id="net-raw-recv-rate">-</span></div>
      </div>
    </div>

    <div class="center-column">
      <div id="fetch-error" class="fetch-error" style="display:none;">Connection lost — retrying...</div>
      <div class="ui-scale">
      <div id="display-area">
      <div class="gauges" id="gauges-area" {% if config.display=='gauges' %}style="display:flex;"{% else %}style="display:none;"{% endif %}>
      <div class="gauge" id="g-cpu">
        <svg viewBox="0 0 36 36" class="circular-chart">
          <path class="circle-bg"
            d="M18 2.0845
               a 15.9155 15.9155 0 0 1 0 31.831
               a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path id="cpu-arc" class="circle" stroke-dasharray="0,100"
            d="M18 2.0845
               a 15.9155 15.9155 0 0 1 0 31.831
               a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <text x="18" y="18" class="percentage large" id="cpu-label" transform="rotate(90 18 18)">-%</text>
        </svg>
        <div class="g-title">CPU</div>
        <div class="g-info" id="cpu-info">-</div>
  </div>

  <div class="gauge" id="g-ram">
        <svg viewBox="0 0 36 36" class="circular-chart">
          <path class="circle-bg"
            d="M18 2.0845
               a 15.9155 15.9155 0 0 1 0 31.831
               a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path id="ram-arc" class="circle" stroke-dasharray="0,100"
            d="M18 2.0845
               a 15.9155 15.9155 0 0 1 0 31.831
               a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <text x="18" y="18" class="percentage large" id="ram-label" transform="rotate(90 18 18)">-%</text>
        </svg>
        <div class="g-title">RAM</div>
        <div class="g-info" id="ram-info">-</div>
  </div>

  <div class="gauge" id="g-net">
        <div class="net-stack">
          <div class="net-gauge small" id="g-net-up">
            <svg viewBox="0 0 36 36" class="circular-chart">
              <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <path id="net-up-arc" class="circle" stroke-dasharray="0,100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <text x="18" y="18" class="percentage" id="net-up-label" transform="rotate(90 18 18)">-</text>
            </svg>
            <div class="g-title">Up</div>
          </div>
          <div class="net-gauge small" id="g-net-down">
            <svg viewBox="0 0 36 36" class="circular-chart">
              <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <path id="net-down-arc" class="circle" stroke-dasharray="0,100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <text x="18" y="18" class="percentage" id="net-down-label" transform="rotate(90 18 18)">-</text>
            </svg>
            <div class="g-title">Down</div>
          </div>
        </div>
        <div class="g-info small" id="net-up-info">-</div>
        <div class="g-info small" id="net-down-info">-</div>
  </div>
  </div>

  <div class="bars" id="bars-area" {% if config.display=='bars' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
        <div class="bar-gauge">
          <div class="bar-title">CPU</div>
          <div class="bar-track"><div id="cpu-bar-fill" class="bar-fill"></div></div>
          <div class="bar-meta"><span id="cpu-bar-label">-</span>% • <span id="cpu-bar-sub">-</span></div>
        </div>

        <div class="bar-gauge">
          <div class="bar-title">RAM</div>
          <div class="bar-track"><div id="ram-bar-fill" class="bar-fill"></div></div>
          <div class="bar-meta"><span id="ram-bar-label">-</span>% • <span id="ram-bar-sub">-</span></div>
        </div>
        <div class="bar-gauge">
          <div class="bar-title">Network</div>
          <div class="bar-track small"><div id="net-up-bar-fill" class="bar-fill up"></div></div>
          <div class="bar-track small"><div id="net-down-bar-fill" class="bar-fill down"></div></div>
          <div class="bar-meta"><span id="net-bar-label">-</span> • <span id="net-bar-sub">-</span></div>
        </div>
      </div>
    </div>

    </div>

    <script id="jelly-config-json" type="application/json">{{ {'time_format_12': (config.time_format == '12'), 'show_update_time': config.show_update_time }|tojson }}</script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        (function(){
      function humanBytes(n){
      if (n===0) return '0 B';
      const units = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(n)/Math.log(1024));
      return (n/Math.pow(1024,i)).toFixed(1) + ' ' + units[i];
    }
    // Use server-side configured display mode and config flags
      // Use server-side configured display mode and config flags
      const serverDisplay = '{{ config.display|default("gauges") }}';
      // Server-rendered config saved as JSON to avoid embedding Jinja tokens inside JS expressions
      // Parse the JSON from the script tag below to populate JELLY_CONFIG
      const jellyConfigScript = document.getElementById('jelly-config-json');
      const JELLY_CONFIG = jellyConfigScript ? JSON.parse(jellyConfigScript.textContent) : { time_format_12: true, show_update_time: true };
    function setDisplayMode(mode){
      document.getElementById('gauges-area').style.display = mode==='gauges' ? 'flex' : 'none';
      document.getElementById('bars-area').style.display = mode==='bars' ? 'block' : 'none';
    }
    setDisplayMode(serverDisplay);

    let fetchBackoff = 2000; // initial poll interval
    let fetchFailures = 0;
    async function fetchStats(){
      try{
        const res = await fetch('/api/stats');
        if(!res.ok) throw new Error('network');
        const data = await res.json();
        // success — hide error banner and reset backoff
        const errEl = document.getElementById('fetch-error'); if(errEl) errEl.style.display = 'none';
        fetchFailures = 0;
        fetchBackoff = 2000;
        // Update gauge arcs (SVG circle uses stroke-dasharray: <percent>,100)
        const cpu = Math.round(data.cpu_percent);
        const ram = Math.round(data.memory.percent);
  // Network up/down separate values
  const netSentPerSec = data.network && data.network.sent_per_sec ? data.network.sent_per_sec : 0;
  const netRecvPerSec = data.network && data.network.recv_per_sec ? data.network.recv_per_sec : 0;
  // baseline from server is in Mbps; convert to bytes/sec (use decimal Mbps -> bytes) and compute percent using bytes/sec to avoid unit mismatches
  const baseline_mbps = data.network && data.network.baseline_mbps ? data.network.baseline_mbps : 1000;
  const baseline_bytes_per_s = (baseline_mbps * 1000000) / 8; // Mbps -> bytes/s (1 Mbps = 1,000,000 bits/s)
  const netUpPercent = baseline_bytes_per_s > 0 ? Math.min(100, Math.round((netSentPerSec / baseline_bytes_per_s) * 100)) : 0;
  const netDownPercent = baseline_bytes_per_s > 0 ? Math.min(100, Math.round((netRecvPerSec / baseline_bytes_per_s) * 100)) : 0;
        const cpuArc = document.getElementById('cpu-arc');
        const ramArc = document.getElementById('ram-arc');
        cpuArc.setAttribute('stroke-dasharray', `${cpu},100`);
        ramArc.setAttribute('stroke-dasharray', `${ram},100`);
  const netUpArc = document.getElementById('net-up-arc');
  const netDownArc = document.getElementById('net-down-arc');
  if(netUpArc) netUpArc.setAttribute('stroke-dasharray', `${netUpPercent},100`);
  if(netDownArc) netDownArc.setAttribute('stroke-dasharray', `${netDownPercent},100`);
        document.getElementById('cpu-label').textContent = cpu + '%';
        document.getElementById('ram-label').textContent = ram + '%';
  const netUpLabel = document.getElementById('net-up-label'); if(netUpLabel) netUpLabel.textContent = netUpPercent + '%';
  const netDownLabel = document.getElementById('net-down-label'); if(netDownLabel) netDownLabel.textContent = netDownPercent + '%';
        // Apply threshold classes
        function thresholdClass(v){
          if(v >= 90) return 'danger';
          if(v >= 70) return 'warn';
          return 'success';
        }
        const cpuCls = thresholdClass(cpu);
        const ramCls = thresholdClass(ram);
  const netUpCls = thresholdClass(netUpPercent);
  const netDownCls = thresholdClass(netDownPercent);
  cpuArc.classList.remove('success','warn','danger'); cpuArc.classList.add(cpuCls);
  ramArc.classList.remove('success','warn','danger'); ramArc.classList.add(ramCls);
  if(netUpArc){ netUpArc.classList.remove('success','warn','danger'); netUpArc.classList.add(netUpCls); }
  if(netDownArc){ netDownArc.classList.remove('success','warn','danger'); netDownArc.classList.add(netDownCls); }
  const used = humanBytes(data.memory.used);
  const total = humanBytes(data.memory.total);
  // Update info under gauges
  const cpuInfo = document.getElementById('cpu-info');
  const ramInfo = document.getElementById('ram-info');
  if(cpuInfo) cpuInfo.textContent = (data.cpu_count ? data.cpu_count + ' cores' : (data.per_core ? data.per_core.length + ' cores' : '')) + (data.cpu_freq ? (' • ' + data.cpu_freq + ' GHz') : '');
  if(ramInfo) ramInfo.textContent = used + ' / ' + total;
  const netInfo = document.getElementById('net-info');
  // per-gauge small info: show total bytes and rate under each gauge
  const netUpInfo = document.getElementById('net-up-info');
  const netDownInfo = document.getElementById('net-down-info');
  let upBytes = data.network && (data.network.bytes_sent !== null && data.network.bytes_sent !== undefined) ? humanBytes(data.network.bytes_sent) : '-';
  let downBytes = data.network && (data.network.bytes_recv !== null && data.network.bytes_recv !== undefined) ? humanBytes(data.network.bytes_recv) : '-';
  let upRate = data.network && (data.network.sent_per_sec !== null && data.network.sent_per_sec !== undefined) ? humanBytes(Math.round(data.network.sent_per_sec)) + '/s' : '-';
  let downRate = data.network && (data.network.recv_per_sec !== null && data.network.recv_per_sec !== undefined) ? humanBytes(Math.round(data.network.recv_per_sec)) + '/s' : '-';
  if(upRate === '-' && data.network && data.network.sent_per_sec === 0) upRate = '0 B/s';
  if(downRate === '-' && data.network && data.network.recv_per_sec === 0) downRate = '0 B/s';
  if(netUpInfo) netUpInfo.textContent = `${upBytes} • ${upRate}`;
  if(netDownInfo) netDownInfo.textContent = `${downBytes} • ${downRate}`;
  console.debug('NET', {up: data.network && data.network.sent_per_sec, down: data.network && data.network.recv_per_sec, upPct: netUpPercent, downPct: netDownPercent});
    // Update bars (custom div fills)
    const cpuFill = document.getElementById('cpu-bar-fill');
    const ramFill = document.getElementById('ram-bar-fill');
    if(cpuFill){ cpuFill.style.width = cpu + '%'; document.getElementById('cpu-bar-label').textContent = cpu; cpuFill.classList.remove('success','warn','danger'); cpuFill.classList.add(cpuCls); }
    if(ramFill){ ramFill.style.width = ram + '%'; document.getElementById('ram-bar-label').textContent = ram; ramFill.classList.remove('success','warn','danger'); ramFill.classList.add(ramCls); }
  const netUpFill = document.getElementById('net-up-bar-fill'); if(netUpFill){ netUpFill.style.width = netUpPercent + '%'; netUpFill.classList.remove('success','warn','danger'); netUpFill.classList.add(netUpCls); }
  const netDownFill = document.getElementById('net-down-bar-fill'); if(netDownFill){ netDownFill.style.width = netDownPercent + '%'; netDownFill.classList.remove('success','warn','danger'); netDownFill.classList.add(netDownCls); }
    // Subtexts for bars (include GHz for CPU if available)
    const cpuBarSub = document.getElementById('cpu-bar-sub');
    if(cpuBarSub){
      let cpuSub = data.cpu_count ? data.cpu_count + ' cores' : '';
      if(data.cpu_freq) cpuSub += (cpuSub ? ' • ' : '') + (Number(data.cpu_freq).toFixed(1) + ' GHz');
      cpuBarSub.textContent = cpuSub;
    }
    const ramBarSub = document.getElementById('ram-bar-sub'); if(ramBarSub) ramBarSub.textContent = used + ' / ' + total;
    const netBarSub = document.getElementById('net-bar-sub'); if(netBarSub){
        const sentRate = data.network && (data.network.sent_per_sec !== null && data.network.sent_per_sec !== undefined) ? humanBytes(Math.round(data.network.sent_per_sec)) + '/s' : '-';
        const recvRate = data.network && (data.network.recv_per_sec !== null && data.network.recv_per_sec !== undefined) ? humanBytes(Math.round(data.network.recv_per_sec)) + '/s' : '-';
        netBarSub.textContent = `Up: ${sentRate} • Down: ${recvRate}`;
      }
  // Also update raw elements if present (full stats)
  const cpuRaw = document.getElementById('cpu-raw'); if(cpuRaw) cpuRaw.textContent = cpu;
  const perCoreEl = document.getElementById('cpu-percore'); if(perCoreEl) perCoreEl.textContent = data.per_core && data.per_core.length ? data.per_core.join(', ') : '-';
  const cpuCoresEl = document.getElementById('cpu-cores'); if(cpuCoresEl) cpuCoresEl.textContent = data.cpu_count || '-';
  const cpuFreqEl = document.getElementById('cpu-freq'); if(cpuFreqEl) cpuFreqEl.textContent = data.cpu_freq ? Number(data.cpu_freq).toFixed(2) : '-';
  const netRawSent = document.getElementById('net-raw-sent'); if(netRawSent) netRawSent.textContent = data.network && data.network.bytes_sent ? humanBytes(data.network.bytes_sent) : '-';
  const netRawRecv = document.getElementById('net-raw-recv'); if(netRawRecv) netRawRecv.textContent = data.network && data.network.bytes_recv ? humanBytes(data.network.bytes_recv) : '-';
  const netRawSentRate = document.getElementById('net-raw-sent-rate'); if(netRawSentRate) netRawSentRate.textContent = data.network && data.network.sent_per_sec ? humanBytes(Math.round(data.network.sent_per_sec)) + '/s' : '-';
  const netRawRecvRate = document.getElementById('net-raw-recv-rate'); if(netRawRecvRate) netRawRecvRate.textContent = data.network && data.network.recv_per_sec ? humanBytes(Math.round(data.network.recv_per_sec)) + '/s' : '-';
  const ramRaw = document.getElementById('ram-raw'); if(ramRaw) ramRaw.textContent = ram;
  const ramUsedEl = document.getElementById('ram-used'); if(ramUsedEl) ramUsedEl.textContent = used;
  const ramAvailEl = document.getElementById('ram-available'); if(ramAvailEl) ramAvailEl.textContent = humanBytes(data.memory.available);
  const ramTotalEl = document.getElementById('ram-total'); if(ramTotalEl) ramTotalEl.textContent = total;
  // format update time according to user setting (12h or 24h)
  const use12 = JELLY_CONFIG.time_format_12;
  const timeOpts = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: use12 };
  const formatted = new Date(data.timestamp*1000).toLocaleTimeString([], timeOpts);
  const globalEl = document.getElementById('global-updated-time'); if(globalEl) globalEl.textContent = formatted;
  // show/hide global update time based on user setting and optionally start live ticking
  const showGlobal = JELLY_CONFIG.show_update_time;
  const globalWrapper = document.getElementById('global-updated');
  if(showGlobal){
    if(globalWrapper) globalWrapper.style.display = 'block';
    if(!window._jellystat_tick){
      window._jellystat_tick = setInterval(()=>{
        const now = new Date();
        const timeOptsTick = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: JELLY_CONFIG.time_format_12 };
        const el = document.getElementById('global-updated-time'); if(el) el.textContent = now.toLocaleTimeString([], timeOptsTick);
      }, 1000);
    }
  }else{
    if(globalWrapper) globalWrapper.style.display = 'none';
    if(window._jellystat_tick){ clearInterval(window._jellystat_tick); window._jellystat_tick = null; }
  }
      }catch(e){
        console.error('Failed to fetch stats', e);
        fetchFailures += 1;
        fetchBackoff = Math.min(30000, fetchBackoff * 2);
        const errEl = document.getElementById('fetch-error'); if(errEl) errEl.style.display = 'block';
      }
      // schedule next poll with current backoff (resets on success)
      setTimeout(fetchStats, fetchBackoff);
    }
    fetchStats();
    // Autoscale UI: adjust --ui-scale based on available width. Delay initial measurement until
    // window.load so stylesheets have been applied (avoids forced layout/FOUC warnings).
    function autoscaleUI(){
      const containerWidth = document.body.clientWidth;
      const base = 1200;
      let scale = Math.min(1.4, Math.max(0.6, containerWidth / base));
      const wrapper = document.querySelector('.ui-scale');
      if(wrapper) wrapper.style.setProperty('--ui-scale', scale);
      else document.documentElement.style.setProperty('--ui-scale', scale);
    }
    // Debounced resize handler
    let _autoscale_timer = null;
    window.addEventListener('resize', () => { clearTimeout(_autoscale_timer); _autoscale_timer = setTimeout(autoscaleUI, 150); });
    // Run autoscale after window.load (ensures CSS applied)
    if (document.readyState === 'complete') {
      autoscaleUI();
    } else {
      window.addEventListener('load', () => { autoscaleUI(); });
    }
        })();
      });
    </script>

{% endblock %}
